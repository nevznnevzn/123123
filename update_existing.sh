#!/bin/bash

# ðŸ”„ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Solar Balance Bot
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: sudo bash update_existing.sh

set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° root Ð¿Ñ€Ð°Ð²
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root (sudo)"
        exit 1
    fi
}

# ÐŸÐ¾Ð¸ÑÐº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
find_existing_installation() {
    log_info "ÐŸÐ¾Ð¸ÑÐº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸..."
    
    # Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
    possible_paths=(
        "/home/solarbot/solarbalance"
        "/home/solarbalance/solarbalance"
        "/home/solarbalance/solarbalance-bot"
        "/opt/solarbalance"
        "/var/www/solarbalance"
    )
    
    for path in "${possible_paths[@]}"; do
        if [[ -d "$path" && -f "$path/main.py" ]]; then
            log_success "ÐÐ°Ð¹Ð´ÐµÐ½Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð²: $path"
            return 0
        fi
    done
    
    log_error "Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
    log_info "Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹:"
    log_info "1. Ð‘Ð¾Ñ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð² Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸"
    log_info "2. Ð‘Ð¾Ñ‚ Ð½Ðµ Ð±Ñ‹Ð» ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ñ€Ð°Ð½ÐµÐµ"
    log_info "3. Ð¤Ð°Ð¹Ð» main.py Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
    
    read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿ÑƒÑ‚ÑŒ Ðº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ (Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸): " custom_path
    
    if [[ -n "$custom_path" && -d "$custom_path" && -f "$custom_path/main.py" ]]; then
        log_success "ÐÐ°Ð¹Ð´ÐµÐ½Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð²: $custom_path"
        return 0
    elif [[ -z "$custom_path" ]]; then
        log_info "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ..."
        exec bash install_server.sh
    else
        log_error "Ð£ÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²Ð°Ð»Ð¸Ð´Ð½ÑƒÑŽ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Ð±Ð¾Ñ‚Ð°"
        exit 1
    fi
}

# Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
create_backup() {
    local install_path="$1"
    local backup_dir="/tmp/solarbalance_backup_$(date +%Y%m%d_%H%M%S)"
    
    log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸..."
    
    mkdir -p "$backup_dir"
    
    # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    if [[ -f "$install_path/.env" ]]; then
        cp "$install_path/.env" "$backup_dir/"
        log_info "Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½ .env Ñ„Ð°Ð¹Ð»"
    fi
    
    if [[ -f "$install_path/astro_bot.db" ]]; then
        cp "$install_path/astro_bot.db" "$backup_dir/"
        log_info "Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð±Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…"
    fi
    
    if [[ -d "$install_path/logs" ]]; then
        cp -r "$install_path/logs" "$backup_dir/"
        log_info "Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð»Ð¾Ð³Ð¸"
    fi
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²
    tar -czf "${backup_dir}.tar.gz" -C /tmp "$(basename "$backup_dir")"
    rm -rf "$backup_dir"
    
    log_success "Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°: ${backup_dir}.tar.gz"
}

# ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°
stop_service() {
    log_info "ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°..."
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð¸Ð¼ÐµÐ½Ð° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
    service_names=("solarbalance-bot" "solarbalance" "solarbot")
    
    for service in "${service_names[@]}"; do
        if systemctl is-active --quiet "$service" 2>/dev/null; then
            log_info "ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ: $service"
            systemctl stop "$service"
            break
        fi
    done
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Python
    pids=$(pgrep -f "python.*main.py" 2>/dev/null || true)
    if [[ -n "$pids" ]]; then
        log_info "Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² Python..."
        kill $pids 2>/dev/null || true
        sleep 2
    fi
}

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð°
update_code() {
    local install_path="$1"
    
    log_info "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð°..."
    
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    local user=$(stat -c '%U' "$install_path")
    local group=$(stat -c '%G' "$install_path")
    
    log_info "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: $user, Ð³Ñ€ÑƒÐ¿Ð¿Ð°: $group"
    
    # Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
    if [[ -d "$install_path/.git" ]]; then
        log_info "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹, Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· git..."
        su - "$user" -c "cd '$install_path' && git fetch origin && git reset --hard origin/main"
    else
        log_info "ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
        local temp_dir="/tmp/solarbalance_update_$(date +%s)"
        mkdir -p "$temp_dir"
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ (Ð½Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹)
        cp -r . "$temp_dir/"
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (ÐºÑ€Ð¾Ð¼Ðµ Ð²Ð°Ð¶Ð½Ñ‹Ñ…)
        cd "$install_path"
        find . -type f \( -name "*.py" -o -name "*.sh" -o -name "*.md" -o -name "requirements*.txt" \) -delete
        find . -type d \( -name "handlers" -o -name "services" -o -name "tests" \) -exec rm -rf {} + 2>/dev/null || true
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        cp -r "$temp_dir"/* .
        
        # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
        rm -rf "$temp_dir"
    fi
    
    # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð°
    chown -R "$user:$group" "$install_path"
}

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
update_dependencies() {
    local install_path="$1"
    local user=$(stat -c '%U' "$install_path")
    
    log_info "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
    
    # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ venv Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
    su - "$user" -c "cd '$install_path' && source venv/bin/activate && pip install --upgrade pip"
    
    if [[ -f "$install_path/requirements-prod.txt" ]]; then
        su - "$user" -c "cd '$install_path' && source venv/bin/activate && pip install -r requirements-prod.txt --upgrade"
    elif [[ -f "$install_path/requirements.txt" ]]; then
        su - "$user" -c "cd '$install_path' && source venv/bin/activate && pip install -r requirements.txt --upgrade"
    else
        log_warning "Ð¤Ð°Ð¹Ð» requirements Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸"
        su - "$user" -c "cd '$install_path' && source venv/bin/activate && pip install aiogram apscheduler pytz sqlalchemy asyncpg aiosqlite openai python-dotenv pyswisseph --upgrade"
    fi
    
    log_success "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
}

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°
update_systemd_service() {
    log_info "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
    
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¸Ð¼Ñ ÑÐµÑ€Ð²Ð¸ÑÐ°
    local service_name="solarbalance-bot"
    local install_path="$1"
    local user=$(stat -c '%U' "$install_path")
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» ÑÐµÑ€Ð²Ð¸ÑÐ°
    cat > /etc/systemd/system/solarbalance-bot.service << EOF
[Unit]
Description=Solar Balance Telegram Bot
After=network.target postgresql.service
Wants=postgresql.service

[Service]
Type=simple
User=$user
Group=$user
WorkingDirectory=$install_path
Environment=PATH=$install_path/venv/bin
ExecStart=$install_path/venv/bin/python main.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    systemctl enable solarbalance-bot
    
    log_success "Systemd ÑÐµÑ€Ð²Ð¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
check_configuration() {
    local install_path="$1"
    
    log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
    
    if [[ ! -f "$install_path/.env" ]]; then
        log_warning "Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹..."
        
        cat > "$install_path/.env" << EOF
# Telegram Bot Token
BOT_TOKEN=your_bot_token_here

# Database (SQLite Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ)
DATABASE_URL=sqlite+aiosqlite:///astro_bot.db

# OpenAI API
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_BASE_URL=https://bothub.chat/api/v2/openai/v1

# Logging
LOG_LEVEL=INFO

# Environment
ENVIRONMENT=production
EOF
        
        local user=$(stat -c '%U' "$install_path")
        chown "$user:$user" "$install_path/.env"
        chmod 600 "$install_path/.env"
        
        log_warning "Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ .env Ñ„Ð°Ð¹Ð». ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐµÐ³Ð¾!"
    else
        log_success "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
    fi
}

# Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°
start_service() {
    log_info "Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°..."
    
    systemctl start solarbalance-bot
    
    # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
    sleep 3
    
    if systemctl is-active --quiet solarbalance-bot; then
        log_success "Ð¡ÐµÑ€Ð²Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
        log_info "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: $(systemctl is-active solarbalance-bot)"
    else
        log_error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°!"
        log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: journalctl -u solarbalance-bot -n 50"
        return 1
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
post_update_check() {
    log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ..."
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°
    if systemctl is-active --quiet solarbalance-bot; then
        log_success "âœ… Ð¡ÐµÑ€Ð²Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
    else
        log_error "âŒ Ð¡ÐµÑ€Ð²Ð¸Ñ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸
    local error_count=$(journalctl -u solarbalance-bot --since "5 minutes ago" | grep -i error | wc -l)
    if [[ $error_count -gt 0 ]]; then
        log_warning "âš ï¸ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ $error_count Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² Ð»Ð¾Ð³Ð°Ñ…"
    else
        log_success "âœ… ÐžÑˆÐ¸Ð±Ð¾Ðº Ð² Ð»Ð¾Ð³Ð°Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
    local process_count=$(pgrep -f "python.*main.py" | wc -l)
    if [[ $process_count -gt 0 ]]; then
        log_success "âœ… ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð±Ð¾Ñ‚Ð° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
    else
        log_error "âŒ ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð±Ð¾Ñ‚Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
    fi
}

# Ð“Ð»Ð°Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Solar Balance Bot"
    echo "=================================================="
    echo ""
    
    check_root
    
    # ÐŸÐ¾Ð¸ÑÐº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
    if ! find_existing_installation; then
        exit 1
    fi
    
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ Ðº ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ
    local install_path=""
    possible_paths=(
        "/home/solarbot/solarbalance"
        "/home/solarbalance/solarbalance"
        "/home/solarbalance/solarbalance-bot"
        "/opt/solarbalance"
        "/var/www/solarbalance"
    )
    
    for path in "${possible_paths[@]}"; do
        if [[ -d "$path" && -f "$path/main.py" ]]; then
            install_path="$path"
            break
        fi
    done
    
    if [[ -z "$install_path" ]]; then
        read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿ÑƒÑ‚ÑŒ Ðº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ: " install_path
        if [[ ! -d "$install_path" || ! -f "$install_path/main.py" ]]; then
            log_error "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ðº ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ"
            exit 1
        fi
    fi
    
    log_info "ÐŸÑƒÑ‚ÑŒ Ðº ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ: $install_path"
    
    # ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
    echo ""
    log_warning "Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð‘ÑƒÐ´ÐµÑ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸!"
    log_info "ÐŸÑƒÑ‚ÑŒ: $install_path"
    read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ? (y/N): " confirm
    
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        log_info "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð¾"
        exit 0
    fi
    
    # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
    create_backup "$install_path"
    stop_service
    update_code "$install_path"
    update_dependencies "$install_path"
    update_systemd_service "$install_path"
    check_configuration "$install_path"
    start_service
    post_update_check
    
    echo ""
    log_success "ðŸŽ‰ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
    echo ""
    echo "ðŸ“ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
    echo "1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð±Ð¾Ñ‚Ð° Ð² Telegram"
    echo "2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: journalctl -u solarbalance-bot -f"
    echo "3. ÐŸÑ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð»"
    echo ""
    echo "ðŸ”§ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
    echo "   sudo systemctl status solarbalance-bot"
    echo "   sudo journalctl -u solarbalance-bot -f"
    echo "   check-solarbot (ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½)"
    echo ""
}

# Ð—Ð°Ð¿ÑƒÑÐº Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
main "$@" 