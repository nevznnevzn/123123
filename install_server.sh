#!/bin/bash

# ðŸš€ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Solar Balance Bot Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: sudo bash install_server.sh

set -e  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° root Ð¿Ñ€Ð°Ð²
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root (sudo)"
        exit 1
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐžÐ¡
check_os() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        OS=$NAME
        VER=$VERSION_ID
    else
        log_error "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½ÑƒÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ"
        exit 1
    fi
    
    log_info "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° ÐžÐ¡: $OS $VER"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ
    if [[ "$OS" != *"Ubuntu"* ]] && [[ "$OS" != *"Debian"* ]]; then
        log_warning "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð»ÑÑ Ð½Ð° Ubuntu/Debian. Ð”Ñ€ÑƒÐ³Ð¸Ðµ ÐžÐ¡ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾."
    fi
}

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
update_system() {
    log_info "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
    apt update && apt upgrade -y
    log_success "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
}

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
install_dependencies() {
    log_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
    
    # ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
    apt install -y python3.11 python3.11-venv python3.11-dev python3-pip
    apt install -y git curl wget build-essential libssl-dev libffi-dev
    
    # PostgreSQL (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
    read -p "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ PostgreSQL? (y/n): " install_postgres
    if [[ $install_postgres =~ ^[Yy]$ ]]; then
        apt install -y postgresql postgresql-contrib libpq-dev
        log_success "PostgreSQL ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
    fi
    
    log_success "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
create_user() {
    log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ solarbot..."
    
    if id "solarbot" &>/dev/null; then
        log_warning "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ solarbot ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    else
        useradd -m -s /bin/bash solarbot
        usermod -aG sudo solarbot
        log_success "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ solarbot ÑÐ¾Ð·Ð´Ð°Ð½"
    fi
}

# ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
clone_repository() {
    log_info "ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
    
    # Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ URL Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
    read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ URL Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸): " repo_url
    
    if [[ -z "$repo_url" ]]; then
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
        if [[ -f "main.py" ]]; then
            log_info "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ ÐºÐ°Ðº Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹"
            cp -r . /home/solarbot/solarbalance
            chown -R solarbot:solarbot /home/solarbot/solarbalance
        else
            log_error "Ð¤Ð°Ð¹Ð» main.py Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸"
            exit 1
        fi
    else
        # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
        su - solarbot -c "cd /home/solarbot && git clone $repo_url solarbalance"
    fi
    
    log_success "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð³Ð¾Ñ‚Ð¾Ð²"
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
setup_venv() {
    log_info "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
    
    su - solarbot -c "cd /home/solarbot/solarbalance && python3.11 -m venv venv"
    su - solarbot -c "cd /home/solarbot/solarbalance && source venv/bin/activate && pip install --upgrade pip"
    
    # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
    if [[ -f "/home/solarbot/solarbalance/requirements-prod.txt" ]]; then
        su - solarbot -c "cd /home/solarbot/solarbalance && source venv/bin/activate && pip install -r requirements-prod.txt"
    elif [[ -f "/home/solarbot/solarbalance/requirements.txt" ]]; then
        su - solarbot -c "cd /home/solarbot/solarbalance && source venv/bin/activate && pip install -r requirements.txt"
    else
        log_warning "Ð¤Ð°Ð¹Ð» requirements Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸"
        su - solarbot -c "cd /home/solarbot/solarbalance && source venv/bin/activate && pip install aiogram apscheduler pytz sqlalchemy asyncpg aiosqlite openai"
    fi
    
    log_success "Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾"
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
setup_config() {
    log_info "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»
    if [[ ! -f "/home/solarbot/solarbalance/.env" ]]; then
        if [[ -f "/home/solarbot/solarbalance/env.example" ]]; then
            cp /home/solarbot/solarbalance/env.example /home/solarbot/solarbalance/.env
        else
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ .env Ñ„Ð°Ð¹Ð»
            cat > /home/solarbot/solarbalance/.env << EOF
# Telegram Bot Token
BOT_TOKEN=your_bot_token_here

# Database (SQLite Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ)
DATABASE_URL=sqlite+aiosqlite:///astro_bot.db

# OpenAI API
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_BASE_URL=https://bothub.chat/api/v2/openai/v1

# Logging
LOG_LEVEL=INFO

# Environment
ENVIRONMENT=production
EOF
        fi
        chown solarbot:solarbot /home/solarbot/solarbalance/.env
        chmod 600 /home/solarbot/solarbalance/.env
    fi
    
    log_warning "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» /home/solarbot/solarbalance/.env Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð²Ð°ÑˆÐ¸ API ÐºÐ»ÑŽÑ‡Ð¸"
    log_success "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° systemd ÑÐµÑ€Ð²Ð¸ÑÐ°
setup_systemd() {
    log_info "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
    
    cat > /etc/systemd/system/solarbalance-bot.service << EOF
[Unit]
Description=Solar Balance Telegram Bot
After=network.target postgresql.service
Wants=postgresql.service

[Service]
Type=simple
User=solarbot
Group=solarbot
WorkingDirectory=/home/solarbot/solarbalance
Environment=PATH=/home/solarbot/solarbalance/venv/bin
ExecStart=/home/solarbot/solarbalance/venv/bin/python main.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    systemctl enable solarbalance-bot
    
    log_success "Systemd ÑÐµÑ€Ð²Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²
setup_logs() {
    log_info "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."
    
    mkdir -p /home/solarbot/solarbalance/logs
    chown -R solarbot:solarbot /home/solarbot/solarbalance/logs
    chmod 755 /home/solarbot/solarbalance/logs
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸ÑŽ Ð»Ð¾Ð³Ð¾Ð²
    cat > /etc/logrotate.d/solarbalance-bot << EOF
/home/solarbot/solarbalance/logs/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 solarbot solarbot
    postrotate
        systemctl reload solarbalance-bot
    endscript
}
EOF
    
    log_success "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°"
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
create_management_scripts() {
    log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ..."
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
    cat > /home/solarbot/update_bot.sh << 'EOF'
#!/bin/bash
echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Solar Balance Bot..."

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
sudo systemctl stop solarbalance-bot

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cd /home/solarbot/solarbalance

# ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ venv
source venv/bin/activate

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
git pull origin main

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
pip install -r requirements-prod.txt --upgrade

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
sudo systemctl start solarbalance-bot

echo "âœ… ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°:"
sudo systemctl status solarbalance-bot --no-pager
EOF
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
    cat > /home/solarbot/check_bot.sh << 'EOF'
#!/bin/bash
echo "ðŸ“Š Solar Balance Bot Status"
echo "=========================="

# Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°
echo "ðŸ”§ Service Status:"
systemctl is-active solarbalance-bot

# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
echo -e "\nðŸ’» Resource Usage:"
ps aux | grep python | grep solarbalance | awk '{print "CPU: " $3 "%, RAM: " $4 "%, PID: " $2}'

# Ð Ð°Ð·Ð¼ÐµÑ€ Ð»Ð¾Ð³Ð¾Ð²
echo -e "\nðŸ“ Log Files:"
du -sh /home/solarbot/solarbalance/logs/

# ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
echo -e "\nâŒ Recent Errors:"
journalctl -u solarbalance-bot --since "1 hour ago" | grep -i error | tail -5
EOF
    
    chmod +x /home/solarbot/update_bot.sh
    chmod +x /home/solarbot/check_bot.sh
    chown solarbot:solarbot /home/solarbot/update_bot.sh
    chown solarbot:solarbot /home/solarbot/check_bot.sh
    
    log_success "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"
}

# Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°
final_setup() {
    log_info "Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°..."
    
    # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ñ„Ð°Ð¹Ð»Ñ‹
    chown -R solarbot:solarbot /home/solarbot/solarbalance
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÑÑ‹Ð»ÐºÐ¸ Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð°
    ln -sf /home/solarbot/update_bot.sh /usr/local/bin/update-solarbot
    ln -sf /home/solarbot/check_bot.sh /usr/local/bin/check-solarbot
    
    log_success "Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
}

# Ð’Ñ‹Ð²Ð¾Ð´ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¹
show_instructions() {
    echo ""
    echo "ðŸŽ‰ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
    echo "========================"
    echo ""
    echo "ðŸ“ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
    echo "1. ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ:"
    echo "   sudo nano /home/solarbot/solarbalance/.env"
    echo ""
    echo "2. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð²Ð°ÑˆÐ¸ API ÐºÐ»ÑŽÑ‡Ð¸ Ð² .env Ñ„Ð°Ð¹Ð»:"
    echo "   - BOT_TOKEN (Ð¾Ñ‚ @BotFather)"
    echo "   - OPENAI_API_KEY (Ð¾Ñ‚ OpenAI Ð¸Ð»Ð¸ Bothub)"
    echo ""
    echo "3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð±Ð¾Ñ‚Ð°:"
    echo "   sudo systemctl start solarbalance-bot"
    echo ""
    echo "4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ:"
    echo "   sudo systemctl status solarbalance-bot"
    echo ""
    echo "5. ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ð»Ð¾Ð³Ð¸:"
    echo "   sudo journalctl -u solarbalance-bot -f"
    echo ""
    echo "ðŸ”§ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
    echo "   update-solarbot    - ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°"
    echo "   check-solarbot     - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ"
    echo "   sudo systemctl restart solarbalance-bot  - ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ"
    echo "   sudo systemctl stop solarbalance-bot     - ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ"
    echo ""
    echo "ðŸ“ Ð¤Ð°Ð¹Ð»Ñ‹:"
    echo "   ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ: /home/solarbot/solarbalance/.env"
    echo "   Ð›Ð¾Ð³Ð¸: /home/solarbot/solarbalance/logs/"
    echo "   Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹: /home/solarbot/update_bot.sh, /home/solarbot/check_bot.sh"
    echo ""
}

# Ð“Ð»Ð°Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    echo "ðŸš€ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Solar Balance Bot Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€"
    echo "========================================"
    echo ""
    
    check_root
    check_os
    update_system
    install_dependencies
    create_user
    clone_repository
    setup_venv
    setup_config
    setup_systemd
    setup_logs
    create_management_scripts
    final_setup
    show_instructions
}

# Ð—Ð°Ð¿ÑƒÑÐº Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
main "$@" 