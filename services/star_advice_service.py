import logging
import re
from datetime import datetime, timedelta
from typing import Dict, List, Optional

from models import Location, PlanetPosition

from .ai_predictions import AIPredictionService

logger = logging.getLogger(__name__)


class StarAdviceService:
    """–°–µ—Ä–≤–∏—Å –ó–≤—ë–∑–¥–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–∞ - –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç"""

    # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –∏—Ö –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
    CATEGORY_PRIORITIES = {
        "career": {
            "planets": ["–°–æ–ª–Ω—Ü–µ", "–ú–∞—Ä—Å", "–Æ–ø–∏—Ç–µ—Ä", "–°–∞—Ç—É—Ä–Ω"],
            "houses": [10, 6, 2],
            "transits": ["–°–∞—Ç—É—Ä–Ω", "–Æ–ø–∏—Ç–µ—Ä"],
            "description": "–∫–∞—Ä—å–µ—Ä—ã –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
        },
        "love": {
            "planets": ["–í–µ–Ω–µ—Ä–∞", "–õ—É–Ω–∞", "–ú–∞—Ä—Å", "–°–æ–ª–Ω—Ü–µ"],
            "houses": [7, 5, 8],
            "transits": ["–í–µ–Ω–µ—Ä–∞", "–ú–∞—Ä—Å"],
            "description": "–æ—Ç–Ω–æ—à–µ–Ω–∏–π –∏ –ª—é–±–≤–∏",
        },
        "finances": {
            "planets": ["–í–µ–Ω–µ—Ä–∞", "–Æ–ø–∏—Ç–µ—Ä", "–°–∞—Ç—É—Ä–Ω"],
            "houses": [2, 8, 11],
            "transits": ["–Æ–ø–∏—Ç–µ—Ä", "–°–∞—Ç—É—Ä–Ω"],
            "description": "—Ñ–∏–Ω–∞–Ω—Å–æ–≤ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤",
        },
        "family": {
            "planets": ["–õ—É–Ω–∞", "–í–µ–Ω–µ—Ä–∞", "–°–æ–ª–Ω—Ü–µ"],
            "houses": [4, 3, 10],
            "transits": ["–õ—É–Ω–∞", "–í–µ–Ω–µ—Ä–∞"],
            "description": "—Å–µ–º—å–∏ –∏ –¥–æ–º–∞—à–Ω–∏—Ö –¥–µ–ª",
        },
        "growth": {
            "planets": ["–°–æ–ª–Ω—Ü–µ", "–Æ–ø–∏—Ç–µ—Ä", "–£—Ä–∞–Ω", "–ù–µ–ø—Ç—É–Ω"],
            "houses": [9, 12, 1],
            "transits": ["–Æ–ø–∏—Ç–µ—Ä", "–£—Ä–∞–Ω", "–ù–µ–ø—Ç—É–Ω"],
            "description": "–ª–∏—á–Ω–æ—Å—Ç–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –∏ –¥—É—Ö–æ–≤–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è",
        },
        "other": {
            "planets": ["–°–æ–ª–Ω—Ü–µ", "–õ—É–Ω–∞", "–ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç"],
            "houses": [1, 7, 10],
            "transits": ["–Æ–ø–∏—Ç–µ—Ä", "–°–∞—Ç—É—Ä–Ω"],
            "description": "–æ–±—â–∏—Ö –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤",
        },
    }

    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –Ω–µ–∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    FORBIDDEN_KEYWORDS = [
        # –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –ò–ò
        "–º–æ–¥–µ–ª—å",
        "gpt",
        "chatgpt",
        "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç",
        "ai",
        "–∏–∏",
        "–ø—Ä–æ–≥—Ä–∞–º–º–∞",
        "–∫–æ–¥",
        "—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞",
        "–∞–ª–≥–æ—Ä–∏—Ç–º",
        "–Ω–µ–π—Ä–æ—Å–µ—Ç",
        # –ú–µ–¥–∏—Ü–∏–Ω–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ (—Ç–æ—á–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã)
        "–¥–∏–∞–≥–Ω–æ–∑",
        "–ª–µ—á–µ–Ω–∏–µ",
        "–±–æ–ª–µ–∑–Ω—å",
        "–ø—Ä–µ–ø–∞—Ä–∞—Ç",
        "—Ç–∞–±–ª–µ—Ç–∫",
        "–≤—Ä–∞—á",
        "–º–µ–¥–∏—Ü–∏–Ω",
        "–±–æ–ª—å–Ω–∏—Ü",
        "–æ–ø–µ—Ä–∞—Ü–∏",
        "—Å–∏–º–ø—Ç–æ–º",
        # –î—Ä—É–≥–∏–µ –Ω–µ–∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ–º—ã
        "–ø–æ–≥–æ–¥–∞",
        "–∫—É—Ä—Å –≤–∞–ª—é—Ç",
        "–Ω–æ–≤–æ—Å—Ç–∏",
        "–ø–æ–ª–∏—Ç–∏–∫–∞",
        "–≤—ã–±–æ—Ä—ã",
        "—Ä–µ—Ü–µ–ø—Ç",
        "–≥–æ—Ç–æ–≤",
        "–∫—É–ª–∏–Ω–∞—Ä",
        "—Å–ø–æ—Ä—Ç",
        "—Ñ—É—Ç–±–æ–ª",
        "—Ö–æ–∫–∫–µ–π",
    ]

    # –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å)
    ASTRO_KEYWORDS = [
        "–ø–ª–∞–Ω–µ—Ç",
        "–∑–Ω–∞–∫",
        "–≥–æ—Ä–æ—Å–∫–æ–ø",
        "–∞—Å—Ç—Ä–æ–ª–æ–≥–∏—è",
        "–∞—Å—Ç—Ä–æ–ª–æ–≥",
        "—Ç—Ä–∞–Ω–∑–∏—Ç",
        "—Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥",
        "–Ω–∞—Ç–∞–ª—å–Ω",
        "–∫–∞—Ä—Ç",
        "–∞—Å–ø–µ–∫—Ç",
        "–¥–æ–º",
        "—Å–æ–ª–Ω—Ü–µ",
        "–ª—É–Ω–∞",
        "–≤–µ–Ω–µ—Ä–∞",
        "–º–∞—Ä—Å",
        "–æ—Ç–Ω–æ—à–µ–Ω–∏",
        "–∫–∞—Ä—å–µ—Ä",
        "–ª—é–±–æ–≤",
        "—Å–æ–≤–µ—Ç",
        "–ø—Ä–æ–≥–Ω–æ–∑",
        "—Å—É–¥—å–±–∞",
        "—Ö–∞—Ä–∞–∫—Ç–µ—Ä",
        "–ª–∏—á–Ω–æ—Å—Ç—å",
        "–ø–∞—Ä—Ç–Ω–µ—Ä",
        "—Ä–∞–±–æ—Ç–∞",
        "–¥–µ–Ω—å–≥–∏",
        "—Å–µ–º—å—è",
        "–±—É–¥—É—â–µ–µ",
        # –ù–æ–≤—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∏ –∑–∞–¥–∞—á
        "–∑–∞–¥–∞—á",
        "–ø—Ä–æ–µ–∫—Ç",
        "–æ—Ñ–∏—Å",
        "–∫–æ–ª–ª–µ–≥",
        "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª",
        "—Ç—Ä—É–¥–Ω–æ—Å—Ç—å",
        "–∫–∞—Ä—å–µ—Ä–Ω—ã–π",
        "–¥–æ–ª–∂–Ω–æ—Å—Ç—å",
        "—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª",
        "–∫–æ–º–∞–Ω–¥–∞",
        "–±–æ—Å—Å",
        "–Ω–∞—á–∞–ª—å–Ω–∏–∫",
        "–ø–æ–¥—á–∏–Ω—ë–Ω–Ω",
        "—Ä–∞–∑–≤–∏—Ç–∏–µ",
        "—É—Å–ø–µ—Ö",
        "–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ",
        "—Ü–µ–ª—å",
        "–º–æ—Ç–∏–≤–∞—Ü–∏—è",
        "–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç",
        "–≤—ã–≥–æ—Ä–∞–Ω–∏–µ",
        "–∫–æ–Ω—Ñ–ª–∏–∫—Ç",
        "–ø–æ–≤—ã—à–µ–Ω–∏–µ",
        "–ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã",
        "—Å–º–µ–Ω–∞ —Ä–∞–±–æ—Ç—ã",
        "—É–≤–æ–ª—å–Ω–µ–Ω–∏–µ",
        "—Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å",
        "—Ä–µ–∑—é–º–µ",
        "—Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ",
        "–∫–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç",
    ]

    def __init__(self):
        self.ai_service = AIPredictionService()

    async def validate_question(self, question: str) -> Dict[str, any]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –≤–æ–ø—Ä–æ—Å –¥–ª—è –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

        Returns:
            {"is_valid": bool, "reason": str}
        """
        question_lower = question.lower()

        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        logger.info(f"[StarAdvice] –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞: '{question_lower}'")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        for forbidden in self.FORBIDDEN_KEYWORDS:
            if forbidden in question_lower:
                logger.warning(f"[StarAdvice] –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω–æ–µ —Å–ª–æ–≤–æ: '{forbidden}' –≤ –≤–æ–ø—Ä–æ—Å–µ: '{question_lower}'")
                return {
                    "is_valid": False,
                    "reason": f"–í–æ–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é —Ç–µ–º–∞—Ç–∏–∫—É: '{forbidden}'",
                }

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã
        if len(question.strip()) < 10:
            return {
                "is_valid": False,
                "reason": "–í–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –ø–æ–¥—Ä–æ–±–Ω–µ–µ.",
            }

        if len(question.strip()) > 500:
            return {
                "is_valid": False,
                "reason": "–í–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ú–∞–∫—Å–∏–º—É–º 500 —Å–∏–º–≤–æ–ª–æ–≤.",
            }

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        has_astro_keywords = any(
            keyword in question_lower for keyword in self.ASTRO_KEYWORDS
        )

        # –ï—Å–ª–∏ –Ω–µ—Ç –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Å–ª–æ–≤, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ AI
        if not has_astro_keywords:
            ai_validation = await self._ai_validate_question(question)
            if not ai_validation["is_valid"]:
                return ai_validation

        return {"is_valid": True, "reason": ""}

    async def _ai_validate_question(self, question: str) -> Dict[str, any]:
        """AI-–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""

        if not self.ai_service.client:
            logger.warning("AI –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏")
            return {"is_valid": True, "reason": ""}  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–µ–∑ AI

        try:
            validation_prompt = f"""
            –û—Ü–µ–Ω–∏, –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –¥–ª—è –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:
            "{question}"

            –ù–ï –ü–†–ò–ù–ò–ú–ê–ï–ú:
            - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ–± –ò–ò, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö
            - –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –ª–µ—á–µ–Ω–∏–µ
            - –ü—Ä–æ–≥–Ω–æ–∑—ã –ø–æ–≥–æ–¥—ã, –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç, –Ω–æ–≤–æ—Å—Ç–µ–π
            - –ö—É–ª–∏–Ω–∞—Ä–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã
            - –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            - –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
            - –ü—Ä–æ—Å—å–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥ –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã

            –ü–†–ò–ù–ò–ú–ê–ï–ú:
            - –í–æ–ø—Ä–æ—Å—ã –æ –ª–∏—á–Ω–æ—Å—Ç–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ, –ø–æ–≤–µ–¥–µ–Ω–∏–∏
            - –û—Ç–Ω–æ—à–µ–Ω–∏—è, –ª—é–±–æ–≤—å, —Å–µ–º—å—è
            - –ö–∞—Ä—å–µ—Ä–∞, —Ä–∞–±–æ—Ç–∞, —Ñ–∏–Ω–∞–Ω—Å—ã
            - –ñ–∏–∑–Ω–µ–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—â–∏–µ –º—É–¥—Ä–æ–≥–æ —Å–æ–≤–µ—Ç–∞
            - –í–æ–ø—Ä–æ—Å—ã –æ –±—É–¥—É—â–µ–º, –≤—ã–±–æ—Ä–µ, —Ä–µ—à–µ–Ω–∏—è—Ö
            - –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ–º—ã
            - –í–û–ü–†–û–°–´ –û –†–ê–ë–û–¢–ï, –ó–ê–î–ê–ß–ê–•, –ü–†–û–ï–ö–¢–ê–•, –û–§–ò–°–ï, –ö–û–õ–õ–ï–ì–ê–•, –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–• –¢–†–£–î–ù–û–°–¢–Ø–•, –ö–ê–†–¨–ï–†–ù–´–• –¶–ï–õ–Ø–• ‚Äî –í–°–ï–ì–î–ê –ü–†–ò–ù–ò–ú–ê–ï–ú

            –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: "–ü–†–ò–ù–Ø–¢" –∏–ª–∏ "–û–¢–ö–õ–û–ù–ï–ù"
            """

            # –í—ã–ø–æ–ª–Ω—è–µ–º AI –∑–∞–ø—Ä–æ—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            result_text = await self._make_async_ai_request_validation(validation_prompt)
            
            if not result_text:
                # –ï—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é
                logger.warning("AI –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É")
                return {"is_valid": True, "reason": ""}

            result = result_text.strip().upper()

            if "–ü–†–ò–ù–Ø–¢" in result:
                return {"is_valid": True, "reason": ""}
            else:
                return {
                    "is_valid": False,
                    "reason": "–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å –æ –∂–∏–∑–Ω–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏, –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö, –∫–∞—Ä—å–µ—Ä–µ –∏–ª–∏ –ª–∏—á–Ω–æ—Å—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö.",
                }

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ AI-–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–∞: {e}")
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ AI, –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, –∞ —Å–æ–æ–±—â–∞–µ–º –æ –ø—Ä–æ–±–ª–µ–º–µ
            return {
                "is_valid": False,
                "reason": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞—à –≤–æ–ø—Ä–æ—Å —Å –ø–æ–º–æ—â—å—é AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            }

    async def _make_async_ai_request_validation(self, prompt: str) -> str:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ AI API –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
        import asyncio
        
        def sync_validation_request():
            """–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π AI –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
            try:
                response = self.ai_service.client.chat.completions.create(
                    model="gpt-4o",
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.1,
                    max_tokens=10,
                    timeout=10  # –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                )
                
                if response.choices:
                    return response.choices[0].message.content
                return None
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ AI –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {e}")
                return None
        
        try:
            # –í—ã–ø–æ–ª–Ω—è–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º
            loop = asyncio.get_event_loop()
            result = await asyncio.wait_for(
                loop.run_in_executor(None, sync_validation_request),
                timeout=15  # –û–±—â–∏–π —Ç–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            )
            return result
            
        except asyncio.TimeoutError:
            logger.error("AI –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–µ–≤—ã—Å–∏–ª–∞ —Ç–∞–π–º–∞—É—Ç")
            return None
        except Exception as e:
            logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ AI –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {e}")
            return None

    async def generate_advice(
        self,
        question: str,
        category: str,
        user_planets: Dict[str, PlanetPosition],
        birth_dt: datetime,
        location: Location,
        user_name: str = "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ø—Ä–æ—Å–∞ –∏ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã"""

        if not self.ai_service.client:
            return "‚ùå –°–µ—Ä–≤–∏—Å —Å–æ–≤–µ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API."

        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            priorities = self.CATEGORY_PRIORITIES.get(
                category, self.CATEGORY_PRIORITIES["other"]
            )

            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI
            astro_context = await self._build_astro_context_async(
                user_planets, birth_dt, location, priorities
            )

            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç
            prompt = self._create_advice_prompt(
                question, category, astro_context, user_name, priorities
            )

            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI –ê–°–ò–ù–•–†–û–ù–ù–û
            response = await self._make_async_ai_request(prompt)
            
            if not response:
                return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

            advice = response

            # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            category_desc = priorities["description"]
            header = f"üåü <b>–ó–≤—ë–∑–¥–Ω—ã–π —Å–æ–≤–µ—Ç –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º {category_desc}</b>\n\n"

            result = f"{header}{advice}"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∏ –æ–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if len(result) > 3000:
                available_length = 3000 - len(header) - 10
                # –û–±—Ä–µ–∑–∞–µ–º –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø–æ–ª–Ω–æ–º—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é
                truncated_advice = advice[:available_length]
                last_sentence = truncated_advice.rfind('.')
                if last_sentence > available_length // 2:  # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ—á–∫–∞ –≤ —Ä–∞–∑—É–º–Ω–æ–º –º–µ—Å—Ç–µ
                    advice = truncated_advice[:last_sentence + 1] + "\n\n<i>...</i>"
                else:
                    advice = truncated_advice + "..."
                result = f"{header}{advice}"

            return result

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–≤–µ—Ç–∞: {e}")
            return "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–≤–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

    async def _make_async_ai_request(self, prompt: str) -> str:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ AI API"""
        import asyncio
        import concurrent.futures
        
        def sync_ai_request():
            """–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π AI –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ executor"""
            try:
                response = self.ai_service.client.chat.completions.create(
                    model="gpt-4o",
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.7,
                    max_tokens=400,
                    timeout=20  # –¢–∞–π–º–∞—É—Ç 20 —Å–µ–∫—É–Ω–¥
                )
                
                if response.choices:
                    return response.choices[0].message.content
                return None
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ AI –∑–∞–ø—Ä–æ—Å–∞: {e}")
                return None
        
        try:
            # –í—ã–ø–æ–ª–Ω—è–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            loop = asyncio.get_event_loop()
            result = await asyncio.wait_for(
                loop.run_in_executor(None, sync_ai_request),
                timeout=25  # –û–±—â–∏–π —Ç–∞–π–º–∞—É—Ç 25 —Å–µ–∫—É–Ω–¥
            )
            return result
            
        except asyncio.TimeoutError:
            logger.error("AI –∑–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª —Ç–∞–π–º–∞—É—Ç")
            return None
        except Exception as e:
            logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ AI –∑–∞–ø—Ä–æ—Å–∞: {e}")
            return None

    async def _build_astro_context_async(
        self,
        planets: Dict[str, PlanetPosition],
        birth_dt: datetime,
        location: Location,
        priorities: Dict,
    ) -> str:
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI"""
        context_parts = []

        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ø–ª–∞–Ω–µ—Ç—ã –¥–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        context_parts.append("–ö–õ–Æ–ß–ï–í–´–ï –ü–õ–ê–ù–ï–¢–´:")
        for planet_name in priorities["planets"]:
            if planet_name in planets:
                position = planets[planet_name]
                context_parts.append(
                    f"‚Ä¢ {planet_name} –≤ {position.sign} ({position.degree:.1f}¬∞)"
                )

        # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω–µ—Ç—ã (–∫—Ä–∞—Ç–∫–æ)
        context_parts.append("\n–û–°–¢–ê–õ–¨–ù–´–ï –ü–õ–ê–ù–ï–¢–´:")
        for planet_name, position in planets.items():
            if planet_name not in priorities["planets"]:
                context_parts.append(f"‚Ä¢ {planet_name}: {position.sign}")

        # –î–æ–±–∞–≤–ª—è–µ–º –∞—Å–ø–µ–∫—Ç—ã –ê–°–ò–ù–•–†–û–ù–ù–û (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ —Å–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)
        if (hasattr(self.ai_service, "aspect_calculator") and 
            self.ai_service.aspect_calculator is not None):
            try:
                # –í—ã–ø–æ–ª–Ω—è–µ–º –≤ executor —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å event loop
                import asyncio
                loop = asyncio.get_event_loop()
                aspects = await asyncio.wait_for(
                    loop.run_in_executor(
                        None, 
                        lambda: self.ai_service.aspect_calculator.get_major_aspects(
                            planets, max_count=5
                        )
                    ),
                    timeout=5  # –¢–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∞—Å–ø–µ–∫—Ç—ã
                )
                if aspects:
                    context_parts.append("\n–ö–õ–Æ–ß–ï–í–´–ï –ê–°–ü–ï–ö–¢–´:")
                    for aspect in aspects:
                        context_parts.append(f"‚Ä¢ {aspect}")
            except asyncio.TimeoutError:
                logger.warning("–†–∞—Å—á–µ—Ç –∞—Å–ø–µ–∫—Ç–æ–≤ –ø—Ä–µ–≤—ã—Å–∏–ª —Ç–∞–π–º–∞—É—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞—Å–ø–µ–∫—Ç—ã: {e}")

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∏—Ç—ã –ê–°–ò–ù–•–†–û–ù–ù–û (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ —Å–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)
        if (hasattr(self.ai_service, "transit_calculator") and 
            self.ai_service.transit_calculator is not None):
            try:
                # –í—ã–ø–æ–ª–Ω—è–µ–º –≤ executor —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å event loop
                import asyncio
                loop = asyncio.get_event_loop()
                transits = await asyncio.wait_for(
                    loop.run_in_executor(
                        None, 
                        lambda: self.ai_service.transit_calculator.get_current_transits(
                            birth_dt, location
                        )
                    ),
                    timeout=10  # –¢–∞–π–º–∞—É—Ç 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Ç—Ä–∞–Ω–∑–∏—Ç—ã
                )
                if transits:
                    context_parts.append("\n–¢–ï–ö–£–©–ò–ï –¢–†–ê–ù–ó–ò–¢–´:")
                    for transit in transits[:3]:  # –¢–æ–ª—å–∫–æ —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ
                        context_parts.append(f"‚Ä¢ {transit}")
            except asyncio.TimeoutError:
                logger.warning("–†–∞—Å—á–µ—Ç —Ç—Ä–∞–Ω–∑–∏—Ç–æ–≤ –ø—Ä–µ–≤—ã—Å–∏–ª —Ç–∞–π–º–∞—É—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω–∑–∏—Ç—ã: {e}")

        return "\n".join(context_parts)

    def _create_advice_prompt(
        self,
        question: str,
        category: str,
        astro_context: str,
        user_name: str,
        priorities: Dict,
    ) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–≤–µ—Ç–∞"""

        category_desc = priorities["description"]

        prompt = f"""
        –¢—ã –º—É–¥—Ä—ã–π –∏ –æ–ø—ã—Ç–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Ç–µ–±–µ –∑–∞ —Å–æ–≤–µ—Ç–æ–º –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º {category_desc}.
        
        –ù–ê–¢–ê–õ–¨–ù–ê–Ø –ö–ê–†–¢–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
        {astro_context}
        
        –í–û–ü–†–û–° –û–¢ {user_name.upper()}:
        "{question}"
        
        –ò–ù–°–¢–†–£–ö–¶–ò–ò:
        1. –î–∞–π –º—É–¥—Ä—ã–π, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π —Å–æ–≤–µ—Ç, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–∞—Ö
        2. –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –∏ —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–∞–Ω–∑–∏—Ç–æ–≤
        3. –ë—É–¥—å —ç–º–ø–∞—Ç–∏—á–Ω—ã–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º, –Ω–æ —á–µ—Å—Ç–Ω—ã–º
        4. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Å HTML-—Ç–µ–≥–∞–º–∏ <b> –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
        5. –ú–∞–∫—Å–∏–º—É–º 350 —Å–ª–æ–≤
        6. –ò–∑–±–µ–≥–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π, –¥–∞–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        
        –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
        üîÆ <b>–ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏</b>
        [2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–± –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–∞—Ö]
        
        üí´ <b>–ú–æ–π —Å–æ–≤–µ—Ç</b>
        [–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏]
        
        ‚≠ê <b>–ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ</b>
        [–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è —É—á–µ—Ç–∞]
        
        –ì–æ–≤–æ—Ä–∏ —Ç–µ–ø–ª–æ, –∫–∞–∫ –º—É–¥—Ä—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–∫—Ä–µ–Ω–Ω–µ —Ö–æ—á–µ—Ç –ø–æ–º–æ—á—å.
        """

        return prompt
